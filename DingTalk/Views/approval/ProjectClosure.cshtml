@{
    Layout = null;
}
<!--右侧实体内容-->
<el-main id="partPage" style="position:relative;">
    <div class="head-fixed" onclick="loadPage('/Main/approval')">
        <i class="el-icon-arrow-left"></i>
        项目结题申请-{{nodeInfo.NodeName}}
    </div>
    <el-form :model="ruleForm" :rules="rules" :inline="false" ref="ruleForm" label-width="140px" class="demo-ruleForm">

        @*<el-upload class="upload-demo"
                   action="https://jsonplaceholder.typicode.com/posts/"
                   :before-remove="beforeRemove"
                   multiple
                   :limit="3"
                   :on-exceed="handleExceed"
                   :file-list="fileList">
            <el-button size="small" type="primary">点击上传</el-button>
            <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb</div>
        </el-upload>*@

        <el-form-item label="标题" prop="Title">
            <el-input v-model="ruleForm.Title"></el-input>
        </el-form-item>
        <el-form-item label="申请人">
            <el-input v-model="ruleForm.ApplyMan" style="width:200px;" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="申请部门">
            <el-input v-model="ruleForm.Dept" style="width:200px;" :disabled="true"></el-input>
        </el-form-item>


        <el-form-item label="项目名称" prop="ProjectId">
            <el-select v-model="ruleForm.ProjectId" placeholder="请选择" style="width:400px;" v-on:change="selectProject">
                <el-option v-for="item in projectList"
                           :key="item.ProjectId"
                           :label="item.ProjectId + '-' + item.ProjectName"
                           :value="item.ProjectId">
                    <span style="float: left"> {{item.ProjectId}}-{{ item.ProjectName }} </span>
                    <span style="float: right; color: #8492a6; font-size: 13px"></span>
                </el-option>
            </el-select>
        </el-form-item>
        <el-form-item label="项目类型">
            <el-input v-model="ruleForm.ProjectType " style="width:200px;" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="项目负责人">
            <el-input v-model="ruleForm.ResponsibleMan" style="width:200px;" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="小组成员">
            <el-input v-model="ruleForm.TeamMembers" type="textarea" autosize style="width:500px;" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="计划开始时间">
            <el-input v-model="ruleForm.StartTime" style="width:200px;" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="计划结束时间">
            <el-input v-model="ruleForm.EndTime" style="width:200px;" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="项目开发周期" prop="ActualCycleStart">
            <el-date-picker v-model="timeRange"
                            type="daterange"
                            v-on:change="selectActualTime"
                            range-separator="至"
                            start-placeholder="开始时间"
                            end-placeholder="返回时间">
            </el-date-picker>
        </el-form-item>
        <el-form-item label="项目相关数据">
            <el-table :data="DetailedList" stripe border>
                <el-table-column type="index"></el-table-column>
                <el-table-column v-for="(value,key) in DetailedListConfig" :prop="key" :label="value" :key="key">
                </el-table-column>
            </el-table>
        </el-form-item>


        <el-form-item label="是否有横向合作单位">
            <el-radio-group v-model="ruleForm.IsTransverse">
                <el-radio :label=true>是</el-radio>
                <el-radio :label=false>否</el-radio>
            </el-radio-group>
        </el-form-item>
        <template v-if="ruleForm.IsTransverse">
            <el-form-item label="合同金额" prop="ContractAmount">
                <el-input v-model="ruleForm.ContractAmount"></el-input>
            </el-form-item>
            <el-form-item label="合同编码" prop="ContractNo">
                <el-input v-model="ruleForm.ContractNo"></el-input>
            </el-form-item>
            <el-form-item label="实际到账" prop="ActualMoney">
                <el-input v-model="ruleForm.ActualMoney"></el-input>
            </el-form-item>
            <el-table :data="ApplicationUnit" stripe border>
                <el-table-column type="index"></el-table-column>
                <el-table-column label="操作">
                    <template slot-scope="scope">
                        <el-button size="mini" type="danger" v-on:click="deleteApplicationUnit(scope.$index, scope.row)">删除</el-button>
                    </template>
                </el-table-column>
                <el-table-column v-for="(value,key) in ApplicationUnitConfig" :prop="key" :label="value" :key="key">
                    <template slot-scope="scope">
                        <el-input v-model="scope.row[key]"></el-input>
                    </template>
                </el-table-column>
            </el-table>
            <el-form-item v-for="(value,key) in ApplicationUnitConfig" :label="value" :key="key">
                <el-input v-model="table1[key]"></el-input>
            </el-form-item>
            <el-button v-on:click="addApplicationUnit" type="primary" plain> + 添加</el-button>
        </template>


        <el-form-item label="是否有申报纵向项目">
            <el-radio-group v-model="ruleForm.IsPortrait">
                <el-radio :label=true>是</el-radio>
                <el-radio :label=false>否</el-radio>
            </el-radio-group>
        </el-form-item>
        <template v-if="ruleForm.IsPortrait">
            <el-table :data="LongitudinalProject" stripe border>
                <el-table-column type="index"></el-table-column>
                <el-table-column label="操作">
                    <template slot-scope="scope">
                        <el-button size="mini" type="danger" v-on:click="deleteLongitudinalProject(scope.$index, scope.row)">删除</el-button>
                    </template>
                </el-table-column>
                <el-table-column v-for="(value,key) in LongitudinalProjectConfig" :prop="key" :label="value" :key="key">
                    <template slot-scope="scope">
                        <el-input v-model="scope.row[key]"></el-input>
                    </template>
                </el-table-column>
            </el-table>
            <el-form-item v-for="(value,key) in LongitudinalProjectConfig" :label="value" :key="key">
                <el-input v-model="table1[key]"></el-input>
            </el-form-item>
            <el-button v-on:click="addLongitudinalProject" type="primary" plain> + 添加</el-button>
        </template>



        <template v-for="config in uploadFileConfig" style="border:1px solid">
            <el-form-item :label="config.label" :required="config.must" label-width="220px">
                <el-upload class="upload-demo"
                           :file-list="config.fileList"
                           action="/drawingupload/Upload"
                           :on-remove="handleRemove"
                           :before-remove="beforeRemoveFile"
                           :before-upload="beforeUpload"
                           :on-success="handleSuccess"
                           multiple>
                    <el-button v-on:click="upClick(config.attribute)" size="small" type="primary">点击上传</el-button>
                    <div v-on:click="upClick(config.attribute)" class="el-upload__tip" slot="tip">{{config.point}}</div>
                </el-upload>
            </el-form-item>
            <hr />
        </template>


        <el-form-item label="建议" prop="remark">
            <el-input v-model="ruleForm.remark" type="textarea" autosize style="width:500px;"></el-input>
        </el-form-item>
        <!--添加审批人-->
        <sam-approver-list :nodeList="nodeList" :single="true" :nodedata="nodeInfo"></sam-approver-list>
        <el-form-item>
            <el-button type="primary" v-on:click="onSubmit('ruleForm')" :disabled="disablePage">提交</el-button>
        </el-form-item>
    </el-form>
</el-main>

<script>
    let attribute = ''//切换对应上传文件用
    var demo = new Vue({
        el: "#partPage",
        mixins: [mixin],
        data: function () {
            return {
                nodeList: [],
                nodeInfo: {},
                uploadFileConfig: [
                    {
                        label: '立项书或建议书',
                        attribute: 'SuggestBook1',
                        point: '系统有的内容自动关联文件，没有就是手动上传',
                        fileList: [],
                        must: true
                    },
                    {
                        label: '评审PPT',
                        attribute: 'PPT2',
                        point: '系统有的内容自动关联文件，没有就是手动上传',
                        fileList: [],
                        must: true
                    },
                    {
                        label: '需求规格说明书、产品总体设计书',
                        attribute: 'DemandBook3',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '机械设计图纸',
                        attribute: 'Drawing4',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '电气图纸',
                        attribute: 'Electrical5',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: 'BOM表',
                        attribute: 'Bom6',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '软件源代码',
                        attribute: 'SourceCode7',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '使用说明书/操作手册/技术方案/规格说明书',
                        attribute: 'UseBook8',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '合作协议',
                        attribute: 'CooperationAgreement9',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '产品（样机/成品）图片/影像',
                        attribute: 'Product10',
                        point: '打包上传',
                        fileList: [],
                        must: true
                    },
                    {
                        label: '阶段性整理的问题的分析、解决方案及计划表',
                        attribute: 'Solution11',
                        point: '打包上传',
                        fileList: [],
                        must: true
                    },
                    {
                        label: '纵向项目申请/中期检查/验收资料',
                        attribute: 'AcceptanceData14',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '其他过程文档设计报告、评审报告、项目计划、设计更改报告等',
                        attribute: 'ProcessDocumentation15',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '项目终止情况报告',
                        attribute: 'TerminationReport16',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '装箱单',
                        attribute: 'PackingList17',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    },
                    {
                        label: '客户验收单',
                        attribute: 'AcceptanceSlip18',
                        point: '打包上传',
                        fileList: [],
                        must: false
                    }],
                timeRange: [],
                LongitudinalProjectConfig: {
                    Name: '申报政策名称',
                    No: '专项专题编号',
                    Money: '国拨经费/万',
                    ActualMoney: '实际到账/万'
                },
                ApplicationUnitConfig: {
                    ApplicationUnitName: '转化/应用单位',
                    Customer: '客户/联系人',
                    Post: '职务',
                    Tel: '联系方式'
                },
                fileList: [{
                    name: 'food.jpeg',
                    url: 'https://fuss10.elemecdn.com/3/63/4e7f3a15429bfda99bce42a18cdd1jpeg.jpeg?imageMogr2/thumbnail/360x360/format/webp/quality/100'
                },
                {
                    name: 'food2.jpeg',
                    url: 'https://fuss10.elemecdn.com/3/63/4e7f3a15429bfda99bce42a18cdd1jpeg.jpeg?imageMogr2/thumbnail/360x360/format/webp/quality/100'
                }],
                DetailedListConfig: {
                    Type: '类型',
                    ApplyMan : '申请人',
                    ApplyTime: '申请时间',
                    OldTaskId: '流水号'
                },
                table1: {},
                LongitudinalProject: [],//纵向，表1
                ApplicationUnit: [],//横向，表2
                DetailedList: [],//项目相关数据，类型(项目采购清单、借用清单、维修清单、受理知识产权清单)
                projectFundingList: [],//项目经费使用情况
                ruleForm: {
                    Title: "结题申请",
                    ApplyMan: DingData.nickName,
                    ApplyManId: DingData.userid,
                    Dept: DingData.departName,
                    ProjectId: '',
                    ProjectName: '',
                    IsTransverse: true,
                    IsPortrait: true,
 
                },
                rules: {
                    ActualCycleStart: { required: true, message: '项目开发周期不能为空', trigger: 'blur' },
                    ContractAmount: { required: true, message: '合同金额不能为空', trigger: 'blur' },
                    ContractNo: { required: true, message: '合同编码不能为空', trigger: 'blur' },
                    ActualMoney: { required: true, message: '实际到账不能为空', trigger: 'blur' },
                    ProjectId: { required: true, message: '项目不能为空', trigger: 'blur' }
                }
            }
        },
        methods: {
            handleRemove(file, fileList) {
                console.log(file, fileList);
            },
            handlePreview(file) {
                console.log(file);
            },
            handleExceed(files, fileList) {
                this.$message.warning(`当前限制选择 3 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
            },
            beforeRemove(file, fileList) {
                console.log('beforeRemove~~~~')
                return false
                return this.$confirm(`确定移除 ${file.name}？`);
            },

            //删除表格项
            deleteLongitudinalProject(index) {
                this.LongitudinalProject.splice(index, 1)
            },
            addLongitudinalProject() {
                this.LongitudinalProject.push(_cloneObj(this.table1))
            },
            deleteApplicationUnit(index) {
                this.ApplicationUnit.splice(index, 1)
            },
            addApplicationUnit() {
                this.ApplicationUnit.push(_cloneObj(this.table1))
            },
            onSubmit(formName) {
                for (let con of this.uploadFileConfig) {
                    if (con.must && !this.ruleForm[con.attribute]) {
                        this.$alert(con.label + ' 未上传', '提示信息')
                        return
                    }
                }
                if (this.ruleForm.IsTransverse && this.ApplicationUnit.length == 0) {
                    this.$alert('未填写转化/应用单位情况表', '提示信息')
                    return
                }
                if (this.ruleForm.IsPortrait && this.LongitudinalProject.length == 0) {
                    this.$alert('未填写纵向项目基本情况表', '提示信息')
                    return
                }
                let callBack = (taskId) => {
                    this.ruleForm['TaskId'] = taskId
                    for (let det of this.DetailedList) {
                        det['TaskId'] = taskId
                    }
                    for (let long of this.LongitudinalProject) {
                        long['TaskId'] = taskId
                    }
                    for (let app of this.ApplicationUnit) {
                        app['TaskId'] = taskId
                    }
                    let param = {
                        projectClosure: this.ruleForm,
                        detailedLists: this.DetailedList,
                        applicationUnitList: this.ApplicationUnit,
                        projectFundingList: this.projectFundingList,
                        longitudinalProject: this.LongitudinalProject,
                    }
                    console.log(JSON.stringify(param))
                    this.PostData('ProjectClosure/Save', param, () => {
                        this.$alert('恭喜提交成功', '提示信息', {
                            confirmButtonText: '确定',
                            callback: action => {
                                goHome()
                            }
                        })
                    })
                }
                this.approvalSubmit(formName, {
                    Title: this.ruleForm.Title,
                    Remark: this.ruleForm.remark
                }, callBack)
            },
            selectProject(id) {
                console.log(id)
                for (var proj of this.projectList) {
                    if (proj.ProjectId == id) {
                        delete proj.ApplyMan
                        delete proj.ApplyManId
                        Object.assign(this.ruleForm, proj)
                        proj.ProjectType == '研发类' && proj.ProjectSmallType == '纵向' ? this.uploadFileConfig[15].must = true : this.uploadFileConfig[15].must = false
                    }
                }
                //根据项目显示文件
                this.GetData('ProjectClosure/ReadDefault?projectId=' + id, (res) => {
                    this.uploadFileConfig[0].fileList = []
                    this.uploadFileConfig[1].fileList = []
                    if (!res.fileUrl) {
                        this.ruleForm['SuggestBook1'] = ''
                        this.ruleForm['PPT2'] = ''
                        return
                    }
                    let param1 = []
                    let param2 = []
                    let fileUrl = res.fileUrl.split(',')
                    let mediaId = res.mediaId.split(',')
                    let fileName = res.fileName.split(',')
                    for (let i = 0; i < fileName.length; i++) {
                        let file = {
                            "name": fileName[i],
                            "mediaid": mediaId[i],
                            "response": {
                                "Content": fileUrl[i]
                            }
                        }
                        let param = {
                            "FileUrl": fileUrl[i],
                            "MediaId": mediaId[i],
                            "FileName": fileName[i]
                        }

                        if (fileName[i].indexOf('ppt') > 0 || fileName[i].indexOf('pptx') > 0) {
                            this.uploadFileConfig[1].fileList.push(file)
                            param2.push(param)
                        } else {
                            this.uploadFileConfig[0].fileList.push(file)
                            param1.push(param)
                        }
                    }
                    console.log(this.uploadFileConfig[0])
                    console.log(this.uploadFileConfig[1])
                    console.log(param1)
                    console.log(param2)
                    this.ruleForm['SuggestBook1'] = JSON.stringify(param1)
                    this.ruleForm['PPT2'] = JSON.stringify(param2)
                 
                })
                //根据项目显示bom
                this.GetData('ProjectClosure/ReadFlowInfo?projectId=' + id, (res) => {
                    this.DetailedList = res
                    this.DetailedList['ProjectType'] = res.ProjectType + '(' + res.ProjectSmallType + ')'
                })
            },
            //加载重新发起审批传递的数据
            loadReApprovalData() {
                if (!ReApprovalTempData.valid) return
                this.ruleForm = ReApprovalTempData.ruleForm
                this.LongitudinalProject = ReApprovalTempData.LongitudinalProject
                this.ApplicationUnitConfig = ReApprovalTempData.ApplicationUnitConfig
                this.DetailedList = ReApprovalTempData.DetailedList
                this.ProjectFundingList = ReApprovalTempData.ProjectFundingList

                for (let con of this.uploadFileConfig) {
                    if (this.ruleForm[con.attribute]) {
                        let urlObj = JSON.parse(this.ruleForm[con.attribute])
                        for (let obj of urlObj) {
                            con.fileList.push({
                                name: obj.FileName,
                                path: obj.FileUrl
                            })
                        }
                    }
                }

                ReApprovalTempData.valid = false
                this.purchaseList = ReApprovalTempData.data
            },
            //文件上传处理方法
            upClick(attr) {
                console.log(attr)
                attribute = attr
            },
            beforeUpload(file) {
                const isLt2M = file.size / 1024 / 1024 < 10
                if (!isLt2M) {
                    this.$message.error('上传文件大小不能超过 10MB!')
                    return false
                }
                return true
            },
            beforeRemoveFile(file, fileList) {
                console.log(file)
                return this.$confirm(`确定移除 ${file.name}？`);
            },
            handleRemove(file, fileList) {
                let param = []
                for (let file of fileList) {
                    param.push({
                        "FileUrl": file.response.Content,
                        "MediaId": file.media_id,
                        "FileName": file.name
                    })
                }
                this.ruleForm[attribute] = JSON.stringify(param)
            },
            handleSuccess(response, file, fileList) {
                var that = this
                const loading = this.$loading({
                    lock: true,
                    text: 'Loading',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                var paramObj = {
                    "": file.response.Content
                }
                $.ajax({
                    url: '/DingTalkServers/UploadMedia/',
                    type: 'POST',
                    data: paramObj,
                    success: function (data) {
                        data = JSON.parse(data)
                        console.log('上传文件到钉盘')
                        if (data.media_id) {
                            console.log(data.media_id)
                            fileList[fileList.length - 1]['mediaid'] = data.media_id
                        } else {
                            console.log('无media_di')
                        }
                        let param = []
                        for (let file of fileList) {
                            param.push({
                                "FileUrl": file.response.Content,
                                "MediaId": file.mediaid,
                                "FileName": file.name
                            })
                        }
                        console.log(param)
                        that.ruleForm[attribute] = JSON.stringify(param)
                        console.log(that.ruleForm)
                        loading.close()
                    }
                })
            },
        },
        created: function () {
            this.getNodeInfo()
            this.getApproInfo()
            this.getProjects()
            loadHtml("mainPage", "partPage")
        },

    })
</script>



