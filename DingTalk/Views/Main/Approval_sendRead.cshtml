@{
    Layout = null;
}

<!--右侧实体内容-->
<el-main id="partPage" style="position:relative;">
    <div class="head-fixed" onclick="loadPage('/Main/approval')">
        <i class="el-icon-arrow-left"></i>
        公车申请审批-{{nodeInfo.NodeName}}
    </div>
    <el-form :model="ruleForm" :rules="rules" :inline="true" ref="ruleForm" label-width="120px" class="demo-ruleForm">

        <el-form-item label="标题" prop="Title">
            <el-input v-model="allData.Title" style="width:300px;" :disabled="true"></el-input>
        </el-form-item>
        <el-form-item label="申请人">
            <el-input v-model="allData.ApplyMan" style="width:200px;" :disabled="true"></el-input>
        </el-form-item>

        <el-form-item label="文件标题" prop="MainContent">
            <el-input v-model="ruleForm.MainContent" style="width:500px;"> :disabled="true"</el-input>
        </el-form-item>

        <el-form-item label="来文单位" prop="ReceivingUnit">
            <el-input v-model="ruleForm.ReceivingUnit" style="width:500px;" :disabled="true"></el-input>
        </el-form-item>

        <el-form-item label="文件文号">
            <el-input v-model="ruleForm.FileNo " style="width:500px;" :disabled="true"></el-input>
        </el-form-item>

        <el-form-item label="收文时间" prop="ReceivingTime">
            <el-date-picker v-model="ruleForm.ReceivingTime" :disabled="true"
                            value-format="yyyy-MM-dd"
                            type="date"
                            placeholder="选择日期">
            </el-date-picker>
        </el-form-item>

        <el-form-item label="主要内容" prop="MainIdea">
            <el-input v-model="ruleForm.MainIdea " type="textarea" row="5" style="width:500px;" :disabled="true"></el-input>
        </el-form-item>

        <!--相关文件-->
        <el-form-item v-if="FileList.length > 0" label="相关文件">
            <el-card class="box-card">
                <div v-for="f in FileList" :key="f.name" class="text item">
                    <span>{{ f.name }}</span>
                    <el-button size="mini" type="primary" v-on:click="downloadFile(f.mediaId)">下载</el-button>
                </div>
            </el-card>
        </el-form-item>

        <el-form-item label="拟办意见" prop="Suggestion">
            <el-input v-model="ruleForm.Suggestion" :disabled="NodeId > 1"></el-input>
        </el-form-item>

        <hr />

        <template v-if="NodeId >= 2">
            <el-form-item label="领导阅示" prop="Leadership">
                <el-input v-model="ruleForm.Leadership" :disabled="NodeId>2"></el-input>
            </el-form-item>
        </template>

        <template v-if="NodeId >= 5">
            <el-form-item label="部门阅办情况" prop="Review">
                <el-input v-model="ruleForm.Review" :disabled="NodeId>5"></el-input>
            </el-form-item>
        </template>

        <template v-if="NodeId >= 6">
            <el-form-item label="办理落实情况" prop="HandleImplementation">
                <el-input v-model="ruleForm.HandleImplementation" :disabled="NodeId>6"></el-input>
            </el-form-item>
        </template>

        <!--添加审批人-->
        <sam-approver-list :nodeList="nodeList" :single="true" :nodedata="nodeInfo"></sam-approver-list>
        <el-form-item label="建议" prop="remark">
            <el-input v-model="ruleForm.remark" style="width:500px;"></el-input>
        </el-form-item>
        <el-form-item label="操作" v-if="index==0">
            <el-button type="primary" v-on:click="onSubmit('ruleForm')" :disabeld="disablePage">同意</el-button>
            <el-button v-show="nodeInfo.IsBack" type="warning" v-on:click="returnBk()">退回</el-button>
        </el-form-item>
    </el-form>
</el-main>

<script>
    var allData = {}
    var FileList = []
    if (UrlObj.flowid) {
        FlowId = UrlObj.flowid
        NodeId = UrlObj.nodeid
        TaskId = UrlObj.taskid
        Id = UrlObj.id
        var Index = UrlObj.index
    }
    var demo = new Vue({
        el: "#partPage",
        mixins: [mixin],
        data: function () {
            return {
                FileList: FileList,
                index: Index,
                allData: allData,
                NodeId: NodeId,
                nodeList: [],
                nodeInfo: {},
                ruleForm: {

                }
            }
        },
        methods: {
            onSubmit(formName) {
                console.log('submit!')

                var that = this
                let url = '/CarTable/TableModify'
                var param = _cloneObj(this.ruleForm)
                param.UseKilometres = this.UseKilometres
                this._postData(url, function () {
                    that.aggreSubmit({
                        "Id": allData.Id,
                        "Remark": that.ruleForm.Mark,
                        //"ImageUrl": that.ruleForm.ImageUrl,
                        //"OldImageUrl": that.ruleForm.OldImageUrl
                    })
                },param)

            },
            returnBk() {
                let param = {
                    "Id": allData.Id,
                    "Remark": this.ruleForm.Mark
                }
                this.returnSubmit(param)
            },
            getTable() {
                var that = this
                that._getData('/Receiving/Read', function (data2) {
                    that.ruleForm = data2[0]
                    that.ruleForm['Mark'] = ''
                    
                }
                    , { TaskId: TaskId })
            },

        },
        created: function () {
            this.getNodeInfo()
            this.getApproInfo()
            this.getTable()
            loadHtml("mainPage", "partPage")
        }
    })
    getFormData()


    //获取审批表单信息
    function getFormData() {
        var url = "/FlowInfo/GetApproveInfo?TaskId=" + TaskId + "&ApplyManId=" + DingData.userid
        $.ajax({
            url: url,
            type: "GET",
            dataType: "json",
            success: function (data) {
                console.log("获取审批表单信息ok")
                console.log(url)
                console.log(data)
                allData = data
                if (data.FileUrl && data.FileUrl.length > 5) {
                    var tempList = data.FileUrl.split(',')
                    for (let file of tempList) {
                        FileList.push({
                            name: 'hello.jpg',
                            url: document.location + (file.substring(2)).replace(/\\/g, "/")
                        })
                    }
                }
            },
            error: function (err) {
                console.log(err);
            }
        })
    }

</script>



